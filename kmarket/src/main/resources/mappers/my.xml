<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.kmarket.dao.MyDAO">

	<!--
	 	작성자 : 서정현
	 	용도 : 마이페이지 요약정보 안내 데이터 조회
	 -->
	<select id="selectNavInfo" parameterType="String" resultType="kr.co.kmarket.vo.UserVO">
		SELECT *,
			(
			SELECT COUNT(*) FROM `km_member_coupon`
			WHERE `uid`=#{uid}
			) 'couponCnt',
			(
			SELECT COUNT(*) FROM `km_product_order`
			WHERE `uid`=#{uid} AND `ordState` != '구매확정'
			) 'orderCnt',
			(
			SELECT COUNT(*) FROM	`km_cs`
			WHERE `uid`=#{uid} AND `comment` IS null
			) 'csCnt'
		FROM `km_member_general`
		WHERE `uid`=#{uid} ;
	</select>

	<!--
	 	작성자 : 서정현
	 	용도 : 마이페이지 홈 최근주문내역 조회
	 -->
	<select id="selectOrderLog" parameterType="String" resultType="kr.co.kmarket.vo.OrderVO">
		SELECT
			o.*,
			s.company as company,
			p.prodNo, p.prodName, p.thumb1, p.cate1, p.cate2, s.uid as 'sellerUid'
		FROM `km_product_order` as o
		JOIN `km_product_order_item` as oi
		ON o.`ordNo` = oi.`ordNo`

		JOIN `km_product` as p
		ON oi.`prodNo` = p.`prodNo`

		JOIN `km_member_seller` as s
		ON p.`seller` = s.`uid`

		WHERE o.`uid`=#{uid}
		ORDER BY o.`ordDate` DESC
		LIMIT 5
	</select>

	<!--
	 	작성자 : 서정현
	 	용도 : 마이페이지 홈 포인트적립내역 조회
	 -->
	<select id="selectPointLog" parameterType="String" resultType="kr.co.kmarket.vo.PointVO">
		SELECT *
		FROM `km_member_point`
		WHERE `uid`=#{uid}
		ORDER BY `pointDate` DESC
		LIMIT 5
	</select>

	<!--
	 	작성자 : 서정현
	 	용도 : 마이페이지 홈 상품평 조회
	 -->
	<select id="selectReviewLog" parameterType="String" resultType="kr.co.kmarket.vo.ReviewVO">
		SELECT r.*, p.prodName
		FROM `km_product_review` r
		JOIN `km_product` p
		ON r.`prodNO` = p.`prodNo`
		WHERE `uid`=#{uid}
		ORDER BY `rdate` DESC
		LIMIT 5
	</select>

	<!--
	 	작성자 : 서정현
	 	용도 : 마이페이지 홈 문의내역 조회
	 -->
	<select id="selectCsLog" parameterType="String" resultType="kr.co.kmarket.vo.CsVO">
		SELECT *
		FROM `km_cs`
		WHERE `uid`=#{uid} AND `cate1`='qna'
		ORDER BY `rdate` DESC
		LIMIT 5
	</select>

	<!--
	 	작성자 : 서정현
	 	용도 : 주문 상품 리뷰 작성
	 -->
	<insert id="insertReview" parameterType="kr.co.kmarket.vo.ReviewVO">
		INSERT INTO `km_product_review` SET
			`prodNo`=#{prodNo},
			`uid`=#{uid},
			`content`=#{content},
			`rating`=#{rating},
			`regip`=#{regip},
			`rdate`=NOW()
	</insert>


	<!--
	 	작성자 : 서정현
	 	용도 : 주문내역에서 상품의 주문 번호 클릭시 주문 상품의 정보 표시
	 -->
	<select id="selectOrderAndOrderItem" resultMap="selectJoinOrderAndOrderItem">
		SELECT * FROM `km_product_order` o
		JOIN `km_product_order_item` oi ON o.`ordNo` = oi.`ordNo`
		JOIN `km_product` p ON p.`prodNo` = oi.`prodNo`
		WHERE o.`ordNo`=#{ordNo}
	</select>

	<resultMap id="selectJoinOrderAndOrderItem" type="kr.co.kmarket.vo.OrderVO">
		<id column="ordNo" property="ordNo"/>
		<result column="ordDate" property="ordDate"/>
		<result column="recipName" property="recipName"/>
		<result column="recipHp" property="recipHp"/>
		<result column="recipZip" property="recipZip"/>
		<result column="recipAddr1" property="recipAddr1"/>
		<result column="recipAddr2" property="recipAddr2"/>
		<result column="company" property="company"/>
		<result column="prodName" property="prodName"/>
		<!-- 연관 관계 매핑 -->
		<association property="orderItemVO" javaType="kr.co.kmarket.vo.OrderItemVO">
			<id column="prodNo" property="prodNo"/>
			<result column="price" property="price"/>
			<result column="count" property="count"/>
			<result column="discount" property="discount"/>
			<result column="point" property="point"/>
			<result column="delivery" property="delivery"/>
			<result column="total" property="total"/>

		</association>
	</resultMap>
</mapper>